<div class="location">
  <div class="location-type">{ type }</div>
  <h3>{ name }</h3>
  <h4>{ district || city }</h4>

  {#if exclusion}
    <div class="exclusion">
      <p>{ exclusionNotes }</p>
    </div>
  {:else}
    <div>
      <div class="vaccination-rates row">

        <div class="col col-25 rate">
          <div class="rate-label">
            Enrollment
          </div>

          <div class="rate-vac">
            { enrollment }
          </div>

          <div class="rate-vac-label">
            { type === 'child-care-center' ? 'Children 24 months and older' : '' }
          </div>
        </div>

        <div class="col col-25 rate">
          <div class="rate-label">
            <abbr title="Measles, Mumps, and Rubella">MMR</abbr>
          </div>

          <div class="rate-vac">
            { percent(mmrVac) }
          </div>

          <div class="rate-vac-label">
            Fully vaccinated
          </div>
        </div>

        <div class="col col-50 rate">
          <div class="mmr-vac-chart">
            <Histogram
              data="{ stats.mmrVac.histogram }"
              yMax="{ maxBy(stats.mmrVac.histogram, 'count').count * 1.1 }"
              annotationLines="{ [mmrVac] }">
              The chart belows shows the rate of <abbr title="Measles, Mumps, and Rubella">MMR</abbr> fully vaccinated in all kindergartens and child care centers in Minnesota.  { name } had a rate of { percent(mmrVac) } as of ??.
            </Histogram>
          </div>
        </div>
      </div>

      <div class="vaccination-rates row second-row">

        <div class="col col-20 rate">
          <div class="rate-label">
            <abbr title="Diphtheria, Tetanus, and Whooping cough (Pertussis)">DTaP</abbr>
          </div>

          <div class="rate-vac">
            { percent(dtapVac) }
          </div>

          <div class="rate-vac-label">
            Fully vaccinated
          </div>
        </div>

        <div class="col col-20 rate">
          <div class="rate-label">
            Polio
          </div>

          <div class="rate-vac">
            { percent(polioVac) }
          </div>

          <div class="rate-vac-label">
            Fully vaccinated
          </div>
        </div>

        <div class="col col-20 rate">
          <div class="rate-label">
            Hepatitis B
          </div>

          <div class="rate-vac">
            { percent(hepBVac) }
          </div>

          <div class="rate-vac-label">
            Fully vaccinated
          </div>
        </div>

        <div class="col col-20 rate">
          <div class="rate-label">
            <abbr title="Haemophilus influenzae type b">Hib</abbr>
          </div>

          <div class="rate-vac">
            { percent(hibVac) }
          </div>

          <div class="rate-vac-label">
            Fully vaccinated
          </div>
        </div>

        <div class="col col-20 rate">
          <div class="rate-label">
            Hepatitis A
          </div>

          <div class="rate-vac">
            { percent(hepAVac) }
          </div>

          <div class="rate-vac-label">
            Fully vaccinated
          </div>
        </div>
      </div>
    </div>
  {/if}
</div>

<script>
  import { isNumber, maxBy, find, filter, minBy } from "lodash";
  import Histogram from "./_histogram.svelte.html";
  import styles from "@striblab/strib-styles/build/strib-styles.styles.js";

  export default {
    components: {
      Histogram
    },

    computed: {
      exclusionNotes({ exclusion, type }) {
        if (exclusion === "no-reporting") {
          return "School or center is not reporting this year.";
        } else if (
          exclusion === "no-enrollment" &&
          type === "child-care-center"
        ) {
          return "No enrollment for children 24 months and older.";
        } else if (exclusion === "no-enrollment") {
          return "No enrollment for this school.";
        } else if (exclusion === "low-enrollment") {
          return "Not enough enrollment to have significant data.";
        }

        return "Unknown.";
      }
    },

    helpers: {
      percent(input, placeholder = "-", decimals = 1) {
        if (isNumber(input)) {
          return `${Math.round(input * 100 * Math.pow(10, decimals)) /
            Math.pow(10, decimals)}%`;
        }

        return placeholder;
      },

      maxBy
    },

    data() {
      return {
        stateColor: styles.theme["orange-dark"].hex,
        placeColor: styles["color-text"].hex
      };
    }
  };
</script>
